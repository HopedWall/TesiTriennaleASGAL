\section{Conversione in formato SAM}

\subsection{Cos'è e come funziona}
Come già detto, gli allineamenti ottenuti dallo Splice-Aware aligner sono in un formato non standard chiamato MEM (nota: l'acronimo MEM si riferisce sia al formato dell'output che all'estensione del file ottenuto). L'obiettivo di questa seconda parte è quello di convertire i due file MEM in un singolo file SAM (Sequence Alignment Map), il formato standard per memorizzare gli allineamenti.

Non si tratta solo di una semplice conversione, in quanto è necessario indurre diverse informazioni aggiuntive per avere un file SAM standard, quali: la posizione di inizio dell'allineamento sulla genomica, la stringa CIGAR, i flag relativi all'allineamento, ecc. Per supportare le read paired-end è stato necessario modificare gran parte di queste funzionalità.

In questa sezione saranno descritte le principali modifiche apportate al Formattatore SAM, oltre ad alcune funzionalità aggiuntive utili per la rilevazione di eventi di Alternative Splicing.

\newpage

\subsection{Formato SAM}
Il formato SAM (Sequence Alignment Map) è composto da 11 campi:

\begin{enumerate}
	\item QNAME: Il nome identificativo dell'allineamento
	\item FLAG: Una serie di flag binari che identificano le caratteristiche dell'allineamento
	\item RNAME: Identificativo del gene di riferimento
	\item POS: Posizione 1-based di inizio dell'allineamento sul genoma
	\item MAPQ:  Qualità dell'allineamento
	\item CIGAR: Stringa che identifica le operazioni effettuate per ottenere l'allineamento
	\item RNEXT: QNAME del mate (solo paired-end)
	\item PNEXT: POS del mate	(solo paired-end)
	\item TLEN:  Distanza tra mate (solo paired-end)
	\item SEQ:  	Allineamento vero e proprio
	\item QUAL: Valore Phread della read
\end{enumerate}

\begin{figure}[h]
	\centering
	\includegraphics[width=\linewidth]{images/esempioSAM.png}
  \caption{Un esempio di file SAM prodotto da ASGAL}
  \label{fig:AlternativeSplicingTypes}
\end{figure}

\newpage

\subsection{Modifiche alla computazione del campo FLAG}
Il campo FLAG è il secondo del formato SAM e consiste di un valore numerico (ottenuto convertendo in decimale una serie di flag binari) che rappresenta le caratteristiche dell'allineamento preso in esame. La seguente immagine mostra il significato di ciascun bit del flag:

\begin{figure}[h]
	\centering
	\includegraphics[width=\linewidth]{images/samflag.png}
  \caption{Il significato di ciascun bit del campo FLAG }
  \label{fig:SAM Flags}
\end{figure}

Nei casi single-end solo due flag vengono utilizzati: quello relativo allo strand (0x16) e quello relativo al tipo di allineamento (0x100); visto che le read non sono paired, il flag 0x1 sarà sempre false, quindi tutti i flag risultanti saranno pari.

Nei casi paired-end tutti i flag vengono utilizzati. E' inoltre necessario trattare gli allineamenti a coppie, in quanto il campo FLAG esprime informazioni anche sul mate e non solo sull'allineamento preso in esame. 

Supponiamo ad esempio di avere due read, la prima che mappa sullo strand positivo e la seconda che non mappa (ed è quindi \textit{unmapped}). Sarà innanzitutto necessario mettere a true il flag relativo alle read paired-end (0x1) per entrambe le read. Considerando la prima, sarà messo a true il flag relativo al mate unmapped (0x8) e il flag relativo al first-in-pair (0x4). Considerando la seconda, sarà messo a true il flag relativo alla read unmapped (0x4) e quello relativo al second-in-pair(0x80). I flag in decimale saranno quindi 73 e 133.

Si noti che per il momento non viene tenuto conto dei flag 0x200 e 0x400, ma questo non è di alcuna rilevanza al fine di identificare eventi di Alternative Splicing.

\newpage

\subsection{Calcolo dei campi RNEXT, PNEXT e TLEN}
I campi TLEN, RNEXT e PNEXT rappresentano rispettivamente il settimo, l'ottavo e il nono campo di ogni record del formato SAM; essi sono praticamente inutilizzati quando si allineano read single-end, ma nel formato paired-end assumono maggiore importanza. In particolare i campi RNEXT e PNEXT sono utilizzati da strumenti di visualizzazione degli allineamenti (come ad esempio IGV) per permettere una corretta visualizzazione di una read e del suo mate.

Il campo RNEXT contiene il nome dell'allineamento relativo al mate (ovvero il suo campo PNAME). Per semplicità, quando i due allineamenti sono consecutivi, si può lasciare il suo valore a '='.

Il campo PNEXT contiene la posizione iniziale 1-based dell'allineamento relativo al mate (ovvero il suo campo POS. Qualora il mate fosse unmapped, si utilizza il valore 0.

Il campo TLEN rappresenta la distanza la lunghezza del template osservato, ovvero la distanza (sul genoma) tra l'inizio della prima read e la fine della seconda. Per la sua computazione è sufficiente trovare la posizione finale del secondo allineamento e sottrarre la posizione iniziale del primo.

La seguente immagine mostra un esempio di allineamento visualizzato da IGV:

\begin{figure}[h]
	\centering
	\includegraphics[width=\linewidth]{images/mateinfo.png}
  \caption{Informazioni su mate da SAM formato correttamente}
  \label{fig:Mate info}
\end{figure}

\newpage

E' importante notare che, se questi campi sono settati correttamente, lasciando il cursore del mouse su un allineamento vengono visualizzate tutte le informazioni relative al mate. Al contrario, se si prova ad indicizzare il file BAM (la versione binaria del formato SAM) per l'utilizzo con IGV, e questi campi non sono stati settati correttamente, verrà visualizzato un errore. Un esempio errore è il seguente: se il campo FLAG non contiene 0x8 (quindi il mate è mapped), e si inserisce un valore di PNEXT diverso da 0, al momento dell'indicizzazione sarà visualizzato il messaggio "mapped mate cannot have zero coordinate; treated as unmapped".

\subsection{Calcolo delle statistiche dell'allineamento}
Seguendo l'esempio di altri allineatori (come ad esempio STAR), è stato deciso di visualizzare alcune statistiche in fase di allineamento, quali:

\begin{itemize}
	\item Numero di read mappate e non mappate
	\item Numero di allineamenti primari e secondari
	\item IDMP
	\item tIDMP
\end{itemize}

Questi valori sono visualizzati nel file \textit{.alignsinfo.txt}. Anche se non hanno finalità particolari per la rilevazione di eventi di Alternative Splicing, essi forniscono uno strumento per valutare la qualità degli allineamenti effettuati da ASGAL.
\newpage